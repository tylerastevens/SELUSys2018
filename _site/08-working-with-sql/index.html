<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2017-12-11 11:40:30 -0600">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/SELU.gif" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Python for ecologists: Accessing SQLite Databases Using Python & Pandas</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="http://datacarpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/SELU.gif" alt="Data Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li><a href="../reference/">Reference</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../00-short-introduction-to-Python/">Short Introduction to Programming in Python</a></li>
            
            <li><a href="../01-starting-with-data/">Starting With Data</a></li>
            
            <li><a href="../02-index-slice-subset/">Indexing, Slicing and Subsetting DataFrames in Python</a></li>
            
            <li><a href="../03-data-types-and-format/">Data Types and Formats</a></li>
            
            <li><a href="../04-merging-data/">Combining DataFrames with pandas</a></li>
            
            <li><a href="../05-loops-and-functions/">Data workflows and automation</a></li>
            
            <li><a href="../06-visualization-ggplot-python/">Making Plots With ggplot</a></li>
            
            <li><a href="../07-putting-it-all-together/">Data Ingest & Visualization - Matplotlib & Pandas</a></li>
            
            <li><a href="../08-working-with-sql/">Accessing SQLite Databases Using Python & Pandas</a></li>
            
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../07-putting-it-all-together/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">Python for ecologists</a></h3>
    <h1 class="maintitle">Accessing SQLite Databases Using Python & Pandas</h1>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br/>
      <strong>Exercises:</strong> 25 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Use the sqlite3 module to interact with a SQL database.</p>
</li>
	
	<li><p>Access data stored in SQLite using Python.</p>
</li>
	
	<li><p>Describe the difference in interacting with data stored as a CSV file versus in SQLite.</p>
</li>
	
	<li><p>Describe the benefits of accessing data using a database compared to a CSV file.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h2 id="python-and-sql">Python and SQL</h2>

<p>When you open a CSV in python, and assign it to a variable name, you are using
your computers memory to save that variable. Accessing data from a database like
SQL is not only more efficient, but also it allows you to subset and import only
the parts of the data that you need.</p>

<p>In the following lesson, we’ll see some approaches that can be taken to do so.</p>

<h3 id="the-sqlite3-module">The <code class="highlighter-rouge">sqlite3</code> module</h3>

<p>The <a href="https://docs.python.org/3/library/sqlite3.html">sqlite3</a> module provides a straightforward interface for interacting with
SQLite databases. A connection object is created using <code class="highlighter-rouge">sqlite3.connect()</code>; the
connection must be closed at the end of the session with the <code class="highlighter-rouge">.close()</code> command.
While the connection is open, any interactions with the database require you to
make a cursor object with the <code class="highlighter-rouge">.cursor()</code> command. The cursor is then ready to
perform all kinds of operations with <code class="highlighter-rouge">.execute()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># Create a SQL connection to our SQLite database</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"data/portal_mammals.sqlite"</span><span class="p">)</span>

<span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="c"># the result of a "cursor.execute" can be iterated over by row</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * FROM species;'</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="c">#Be sure to close the connection.</span>
<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="queries">Queries</h3>

<p>One of the most common ways to interact with a database is by querying:
retrieving data based on some search parameters. Use a SELECT statement string.
The query is returned as a single tuple or a tuple of tuples. Add a WHERE
statement to filter your results based on some parameter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># Create a SQL connection to our SQLite database</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"data/portal_mammals.sqlite"</span><span class="p">)</span>

<span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="c"># Return all results of query</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT plot_id FROM plots WHERE plot_type="Control"'</span><span class="p">)</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="c"># Return first result of query</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT species FROM species WHERE taxa="Bird"'</span><span class="p">)</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

<span class="c">#Be sure to close the connection.</span>
<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="accessing-data-stored-in-sqlite-using-python-and-pandas">Accessing data stored in SQLite using Python and Pandas</h2>

<p>Using pandas, we can import results of a SQLite query into a dataframe. Note
that you can use the same SQL commands / syntax that we used in the SQLite
lesson. An example of using pandas together with sqlite is below:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># Read sqlite query results into a pandas DataFrame</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"data/portal_mammals.sqlite"</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s">"SELECT * from surveys"</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>

<span class="c"># verify that result of SQL query is stored in the dataframe</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="storing-data-csv-vs-sqlite">Storing data: CSV vs SQLite</h2>

<p>Storing your data in an SQLite database can provide substantial performance
improvements when reading/writing compared to CSV. The difference in performance
becomes more noticable as the size of the dataset grows (see for example <a href="http://sebastianraschka.com/Articles/2013_sqlite_database.html#results-and-conclusions">these
benchmarks</a>).</p>

<blockquote class="challenge">
  <h2 id="challenge---sql">Challenge - SQL</h2>

  <ol>
    <li>
      <p>Create a query that contains survey data collected between 1998 - 2001 for
  observations of sex “male” or “female” that includes observation’s genus and
  species and plot type for the sample. How many records are returned?</p>
    </li>
    <li>
      <p>Create a dataframe that contains the total number of observations (count)
  made for all years, and sum of observation weights for each plot, ordered by
  plot ID.</p>
    </li>
  </ol>
</blockquote>

<h2 id="storing-data-create-new-tables-using-pandas">Storing data: Create new tables using Pandas</h2>

<p>We can also us pandas to create new tables within an SQLite database. Here, we run we re-do an excercise we did before with CSV files using our SQLite database. We first read in our survey data, then select only those survey results for 2002, and then save it out to its own table so we can work with it on its own later.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"data/portal_mammals.sqlite"</span><span class="p">)</span>

<span class="c"># Load the data into a DataFrame</span>
<span class="n">surveys_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s">"SELECT * from surveys"</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>

<span class="c"># Select only data for 2002</span>
<span class="n">surveys2002</span> <span class="o">=</span> <span class="n">surveys_df</span><span class="p">[</span><span class="n">surveys_df</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2002</span><span class="p">]</span>

<span class="c"># Write the new DataFrame to a new SQLite table</span>
<span class="n">surveys2002</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s">"surveys2002"</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s">"replace"</span><span class="p">)</span>

<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="challenge---saving-your-work">Challenge - Saving your work</h2>

  <ol>
    <li>
      <p>For each of the challenges in the previous challenge block, modify your code to save the
  results to their own tables in the portal database.</p>
    </li>
    <li>
      <p>What are some of the reasons you might want to save the results of your queries back into the
  database? What are some of the reasons you might avoid doing this.</p>
    </li>
  </ol>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
  </ul>
</blockquote>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../07-putting-it-all-together/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


      
      <footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016
	
	<a href="http://datacarpentry.org">Data Carpentry</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="/blob/gh-pages/CITATION">Cite</a>
	/
	<a href="">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    <script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>
